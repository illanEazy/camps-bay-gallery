{% extends 'gallery/base.html' %}
{% load static %}

{% block title %}Verify Email - Camps Bay Art Gallery{% endblock %}

{% block content %}
<section class="auth-section">
    <div class="auth-container">
        <div class="auth-header">
            <h1 class="h1 mb-sm">Verify Your Email</h1>
            <p class="text-large text-gray">We've sent a 6-digit OTP to <strong>{{ email }}</strong></p>
            <p class="text-small text-gray mt-xs">Please check your inbox and enter the code below.</p>
        </div>
        
        <!-- FIXED: Added CSRF token -->
        <form class="auth-form" id="verifyForm" method="POST">
            {% csrf_token %}  <!-- CRITICAL: This was missing! -->
            
            {% if form.errors %}
            <div class="error-message mb-md">
                {% for field in form %}
                    {% for error in field.errors %}
                        {{ error }}
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="form-group">
                <label for="otp_code">6-Digit OTP Code</label>
                <div class="otp-input-group flex flex-between">
                    {% for i in '123456' %}
                    <input type="text" 
                           maxlength="1" 
                           class="otp-digit" 
                           data-index="{{ forloop.counter0 }}"
                           oninput="moveToNext(this)"
                           onkeydown="moveToPrevious(event, this)">
                    {% endfor %}
                </div>
                <input type="hidden" name="otp_code" id="otp_code">
                {% if form.otp_code.errors %}
                <div class="error-message text-small text-red mt-xs">
                    {{ form.otp_code.errors }}
                </div>
                {% endif %}
            </div>
            
            <button type="submit" class="auth-btn">Verify Email</button>
        </form>
        
        <div class="resend-otp mt-lg text-center">
            <p class="text-small text-gray">Didn't receive the code?</p>
            <button class="btn btn-link text-secondary" id="resendOtpBtn">
                <i class="fas fa-redo mr-xs"></i> Resend OTP
            </button>
        </div>
        
        <div class="auth-links mt-lg">
            <a href="{% url 'signup' %}" class="text-small text-gray">
                <i class="fas fa-arrow-left mr-xs"></i> Back to Sign Up
            </a>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Combine OTP digits into single hidden input
        const otpInput = document.getElementById('otp_code');
        const otpDigits = document.querySelectorAll('.otp-digit');
        const verifyForm = document.getElementById('verifyForm');
        
        function updateOtpValue() {
            let otp = '';
            otpDigits.forEach(digit => {
                otp += digit.value;
            });
            otpInput.value = otp;
        }
        
        // Initialize OTP input behavior
        window.moveToNext = function(input) {
            updateOtpValue();
            const index = parseInt(input.getAttribute('data-index'));
            if (input.value.length === 1 && index < 5) {
                otpDigits[index + 1].focus();
            }
        };
        
        window.moveToPrevious = function(event, input) {
            const index = parseInt(input.getAttribute('data-index'));
            if (event.key === 'Backspace' && input.value === '' && index > 0) {
                otpDigits[index - 1].focus();
            }
            setTimeout(updateOtpValue, 0);
        };
        
        // Initialize OTP value
        updateOtpValue();
        
        // Resend OTP functionality
        const resendBtn = document.getElementById('resendOtpBtn');
        if (resendBtn) {
            resendBtn.addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin mr-xs"></i> Sending...';
                
                fetch('{% url "resend_otp" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        user_id: '{{ request.session.pending_user_id }}',
                        otp_type: 'email_verification'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('New OTP sent to your email.');
                        // Clear OTP inputs
                        otpDigits.forEach(digit => digit.value = '');
                        otpDigits[0].focus();
                        updateOtpValue();
                    } else {
                        alert('Error: ' + data.error);
                    }
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-redo mr-xs"></i> Resend OTP';
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-redo mr-xs"></i> Resend OTP';
                });
            });
        }
        
        // Auto-submit when all digits filled
        otpDigits.forEach(digit => {
            digit.addEventListener('input', function() {
                updateOtpValue();
                // Check if all digits filled
                const allFilled = Array.from(otpDigits).every(d => d.value.length === 1);
                if (allFilled) {
                    setTimeout(() => verifyForm.submit(), 300);
                }
            });
        });
    });
</script>
{% endblock %}